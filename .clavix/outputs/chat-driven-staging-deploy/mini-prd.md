# Requirements: Chat-Driven Staging Deploy

*Generated from conversation on 2026-01-09*

## Objective
[HIGH] Make chat-driven app iteration continuously update a “Current preview” (staging) by generating code from the latest AppSpec, committing to a GitHub `staging` branch, and relying on Vercel Git integration to auto-deploy—while keeping the UI consistent for non-technical users and avoiding “deploys the AppSpec” confusion.

## Core Requirements

### Must Have (High Priority)
- [HIGH] Continuous cycle: user sends chat message → system creates/updates AppSpec → compile AppSpec to prompt → v0 generates code → commit to GitHub `staging` → Vercel auto-deploys → “Current preview” updates.
- [HIGH] Remove “Deploy to staging” as a user action; staging deploy is an implementation detail of committing to `staging`.
- [HIGH] Non-technical UI: never show git commit SHAs, branches, or other code-centric identifiers to end users.
- [HIGH] Input locking: while a generation/deploy cycle is running, the chat input is disabled and new messages are rejected (no queueing, no cancellation).
- [HIGH] Inline status only (no global loading overlay): show short status messaging both near the chat input and in the preview panel header.
- [HIGH] Failure behavior (v1): if v0 generation fails (e.g., socket/fetch failure), show a friendly error, unlock chat immediately, and keep the preview link usable (still pointing to the last working deployed preview).
- [HIGH] “Publish” promotes to production by merging `staging` → `main` (production), and remains available as long as at least one successful staging deploy exists.
- [HIGH] Post-publish behavior: after publishing, chat continues the same cycle (updates to `staging` continue) until the user publishes again.

### Should Have (Medium Priority)
- [MEDIUM] Status states that are user-friendly: “Updating preview…”, “Preview ready”, “Couldn’t update preview. Still showing the last working version.”
- [MEDIUM] Vercel project per runtime-created repo (Option A): auto-create/link Vercel project for newly created GitHub repos so commits to `staging` actually deploy.
- [MEDIUM] Persist enough metadata server-side to drive UI states (e.g., “update in progress”, “last successful preview available”) without exposing technical details in UI.

### Could Have (Low Priority / Inferred)
- [LOW] Improve robustness over time by moving v0 generation from sync to async/polling if socket closures persist (explicitly out of scope for v1).

## Technical Constraints
- **Framework/Stack:** Next.js app (existing).
- **Integrations:** v0 SDK chats generation (sync), GitHub API (Octokit) for repo + commits, Vercel API for project linkage and deployment status.
- **Performance/Reliability:** v0 generation currently uses `responseMode: 'sync'` and can fail with socket closure; v1 surfaces errors and unlocks chat without retries.
- **Other:** GitHub org has Vercel Git integration installed with access to all repos (private repos included).

## User Context
**Target Users:** Non-technical users.
**Primary Use Case:** Rapidly iterate on an app by chatting; always have a “Current preview” that reflects the latest successful update.
**User Flow:**
1. User chats to change the app.
2. System updates preview automatically.
3. User repeats until happy.
4. User clicks Publish to update production.

## Edge Cases & Considerations
- [HIGH] In-flight update: preview link should remain usable while status indicates it is updating.
- [HIGH] Failed update: preview remains the last working version; show a friendly “couldn’t update” message; unlock chat.
- [MEDIUM] First-time app: ensure there is a path to create the first successful staging deploy before enabling Publish.
- [MEDIUM] Vercel linkage: repo creation is runtime; Vercel project creation/linking must be automated or staging will never update.

## Implicit Requirements
*Inferred from conversation context - please verify:*
- [UX] “Current preview” should be a stable, user-friendly link (not a transient internal URL) wherever possible.
- [State] The system should have an unambiguous notion of “update running” vs “idle” to disable chat input and drive status.

## Success Criteria
How we know this is complete and working:
- ✓ Sending a chat message triggers an automatic preview update cycle, without any “Deploy to staging” action.
- ✓ While updating, chat input is disabled and users see inline “Updating preview…” status near input and in preview header.
- ✓ If v0 generation fails, users see a friendly error, chat unlocks, and “Current preview” still works.
- ✓ Publish works when a prior successful staging deploy exists, without exposing technical details in the UI.

## Next Steps
1. Review this PRD for accuracy and completeness
2. If anything is missing or unclear, continue the conversation
3. When ready, use the optimized prompt for implementation

---
*This PRD was generated by Clavix from conversational requirements gathering.*

